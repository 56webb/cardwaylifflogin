<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>CardWay | æˆ‘çš„å¡åŒ…è¨­å®š</title>
  <!-- å¼•å…¥ LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- å¼•å…¥ Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Outfit:wght@400;600&display=swap"
    rel="stylesheet">
  <!-- å¼•å…¥ FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      /* LINE é¢¨æ ¼é…è‰² & æ˜äº®ä¸»é¡Œ */
      --primary: #06C755;
      --primary-dark: #05a546;
      --bg: #F5F6F8;
      /* æ·ºç°èƒŒæ™¯ */
      --surface: #FFFFFF;
      --text-main: #111827;
      --text-sub: #6B7280;
      --border: #E5E7EB;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Outfit', 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text-main);
      overflow-x: hidden;
      scroll-behavior: smooth;
    }

    /* Layout */
    .app-container {
      min-height: 100vh;
      padding: 20px;
      padding-bottom: 100px;
      max-width: 500px;
      /* æ‰‹æ©Ÿç‰ˆå‹å„ªåŒ– */
      margin: 0 auto;
      display: flex;
      flex-direction: column;
    }

    /* Modern Card Style (White Cards) */
    .ui-card {
      background: var(--surface);
      border-radius: 20px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .ui-card:active {
      transform: scale(0.995);
    }

    /* Views Transition */
    .view {
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease-out;
    }

    .view.active {
      display: block;
      opacity: 1;
      animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Typography */
    h1 {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 6px;
      color: var(--text-main);
      letter-spacing: -0.5px;
    }

    p.subtitle {
      color: var(--text-sub);
      font-size: 14px;
      margin-bottom: 24px;
      line-height: 1.6;
    }

    /* Home Stats - Modern Grid */
    .stat-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-item {
      background: #F9FAFB;
      padding: 20px 16px;
      border-radius: 16px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .stat-val {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-lbl {
      font-size: 13px;
      color: var(--text-sub);
      margin-top: 4px;
      font-weight: 500;
    }

    /* Visual Credit Card Style */
    .visual-card {
      background: linear-gradient(135deg, #475569 0%, #1e293b 100%);
      color: white;
      padding: 24px;
      border-radius: 20px;
      margin-bottom: 20px;
      position: relative;
      box-shadow: var(--shadow-md);
      overflow: hidden;
      min-height: 180px;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
    }

    /* Dynamic gradients for cards */
    .visual-card[data-bank="013 åœ‹æ³°ä¸–è¯"] {
      background: linear-gradient(135deg, #01a33d 0%, #008530 100%);
    }

    .visual-card[data-bank="822 ä¸­åœ‹ä¿¡è¨—"] {
      background: linear-gradient(135deg, #009E96 0%, #006862 100%);
    }

    .visual-card[data-bank="812 å°æ–°éŠ€è¡Œ"] {
      background: linear-gradient(135deg, #E60012 0%, #99000c 100%);
    }

    .visual-card[data-bank="012 å°åŒ—å¯Œé‚¦"] {
      background: linear-gradient(135deg, #0076CE 0%, #004b85 100%);
    }

    .visual-card[data-bank="808 ç‰å±±éŠ€è¡Œ"] {
      background: linear-gradient(135deg, #00A650 0%, #007036 100%);
    }

    .vc-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: auto;
    }

    .vc-info-main {
      margin-top: auto;
      margin-bottom: auto;
      display: flex;
      flex-direction: column;
    }

    .vc-name {
      font-size: 28px;
      font-weight: 700;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      margin-bottom: 2px;
      line-height: 1.2;
    }

    .vc-bank {
      font-size: 16px;
      font-weight: 500;
      opacity: 0.9;
      letter-spacing: 1.2px;
      text-transform: uppercase;
    }

    .vc-settings-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      color: rgba(255, 255, 255, 0.8);
      cursor: pointer;
      padding: 8px;
      z-index: 20;
      transition: 0.3s;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 50%;
      width: 34px;
      height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .vc-settings-btn:hover {
      background: rgba(0, 0, 0, 0.4);
      transform: rotate(45deg);
    }

    .vc-logo {
      position: absolute;
      bottom: 24px;
      right: 24px;
      font-size: 44px;
      opacity: 0.95;
      filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
    }

    .vc-actions-menu {
      position: absolute;
      top: 55px;
      right: 15px;
      background: #fff;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      display: none;
      flex-direction: column;
      z-index: 30;
      overflow: hidden;
      animation: menuFadeIn 0.2s ease-out;
    }

    @keyframes menuFadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .vc-action-item {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-main);
      font-size: 14px;
      cursor: pointer;
      transition: 0.2s;
    }

    .vc-action-item:hover {
      background: #F3F4F6;
    }

    .vc-action-item i {
      width: 16px;
    }

    .vc-action-item.delete {
      color: #EF4444;
    }

    /* Color Picker UI */
    .color-picker-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(4px);
    }

    .color-picker-content {
      background: #fff;
      padding: 24px;
      border-radius: 24px;
      width: 85%;
      max-width: 320px;
      text-align: center;
    }

    .color-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 20px;
    }

    .color-option {
      aspect-ratio: 1/1;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .color-option:hover {
      transform: scale(1.15) rotate(5deg);
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
    }

    .color-option.active {
      border-color: var(--primary);
      transform: scale(1.1);
    }

    /* Search Bar */
    .search-container {
      margin-bottom: 20px;
      position: relative;
    }

    .search-input {
      width: 100%;
      background: var(--surface);
      border: 2px solid transparent;
      box-shadow: var(--shadow-sm);
      border-radius: 14px;
      padding: 16px 16px 16px 48px;
      color: var(--text-main);
      font-size: 15px;
      outline: none;
      transition: 0.3s;
    }

    .search-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(6, 199, 85, 0.15);
    }

    .search-icon {
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      color: #9CA3AF;
      font-size: 16px;
    }

    /* Bank Pills */
    .bank-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 24px;
      max-height: 200px;
      overflow-y: auto;
      padding: 4px;
    }

    .bank-pill {
      padding: 8px 16px;
      border-radius: 50px;
      background: #F3F4F6;
      color: var(--text-sub);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: 0.2s;
      border: 1px solid transparent;
    }

    .bank-pill:hover {
      background: #E5E7EB;
    }

    .bank-pill.active {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 4px 10px rgba(6, 199, 85, 0.3);
    }

    /* Selection List */
    .selection-list {
      display: grid;
      gap: 12px;
    }

    .selection-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-radius: 16px;
      background: var(--surface);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
    }

    .action-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.2s;
    }

    .add-icon {
      background: #F3F4F6;
      color: var(--primary);
    }

    .add-icon:hover {
      background: var(--primary);
      color: #fff;
    }

    .remove-icon {
      background: #FEE2E2;
      color: #EF4444;
    }

    /* Payment Mapping */
    .pay-section {
      background: var(--surface);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-sm);
    }

    .pay-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      font-weight: 600;
      color: var(--text-main);
    }

    .pay-icon {
      width: 36px;
      height: 36px;
      background: #F3F4F6;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-sub);
      font-size: 16px;
    }

    .chip-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .mini-chip {
      padding: 6px 14px;
      background: #F9FAFB;
      border: 1px solid #E5E7EB;
      border-radius: 50px;
      font-size: 12px;
      color: var(--text-sub);
      cursor: pointer;
      transition: 0.2s;
    }

    .mini-chip.selected {
      background: #DCFCE7;
      /* Light Green */
      border-color: var(--primary);
      color: #166534;
      /* Dark Green Text */
      font-weight: 600;
    }

    /* Navigation Bar (Floating) */
    .nav-bar {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 48px);
      max-width: 450px;
      height: 70px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.5);
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #9CA3AF;
      transition: 0.3s;
      cursor: pointer;
      padding: 8px 16px;
    }

    .nav-item.active {
      color: var(--primary);
      transform: translateY(-2px);
    }

    .nav-item.active i {
      filter: drop-shadow(0 4px 6px rgba(6, 199, 85, 0.4));
    }

    .nav-item i {
      font-size: 22px;
      margin-bottom: 4px;
    }

    .nav-item span {
      font-size: 10px;
      font-weight: 600;
    }

    /* Buttons */
    .primary-btn {
      width: 100%;
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 18px;
      border-radius: 18px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(6, 199, 85, 0.3);
      transition: 0.2s;
    }

    .primary-btn:active {
      transform: scale(0.98);
    }

    /* Toast */
    .toast {
      position: fixed;
      top: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: #111827;
      color: #fff;
      padding: 12px 24px;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 500;
      z-index: 200;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    /* Grouping and Toggle */
    .bank-group-header {
      display: none;
      /* Removed header row as per user request */
    }

    .bank-group-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .bank-card-count {
      background: #F3F4F6;
      color: #6B7280;
      font-size: 11px;
      padding: 2px 10px;
      border-radius: 12px;
      font-weight: 600;
    }

    .toggle-all-btn {
      color: var(--primary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      user-select: none;
      padding: 4px 8px;
      border-radius: 8px;
      transition: 0.2s;
    }

    .toggle-all-btn:active {
      background: rgba(6, 199, 85, 0.1);
    }

    .cards-container {
      position: relative;
      transition: all 0.6s cubic-bezier(0.23, 1, 0.32, 1);
      margin-bottom: 20px;
      cursor: pointer;
    }

    /* Stacked mode - Premium Industry Style */
    .cards-container:not(.expanded) {
      height: 80px;
      /* å¾ 100px ä¸‹èª¿ */
      margin-bottom: 40px;
      /* å¾ 50px ä¸‹èª¿ */
    }

    .cards-container:not(.expanded) .visual-card {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
      z-index: 10;
      margin-bottom: 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }

    /* Tight Elegant Stacking */
    .cards-container:not(.expanded) .visual-card:nth-child(2) {
      transform: translateY(8px) scale(0.985);
      z-index: 9;
      filter: brightness(0.92);
    }

    .cards-container:not(.expanded) .visual-card:nth-child(3) {
      transform: translateY(16px) scale(0.97);
      z-index: 8;
      filter: brightness(0.85);
    }

    .cards-container:not(.expanded) .visual-card:nth-child(n+4) {
      transform: translateY(22px) scale(0.95);
      z-index: 7;
      filter: brightness(0.78);
    }

    /* Expanded mode */
    .cards-container.expanded {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .cards-container.expanded .visual-card {
      position: relative;
      transform: none !important;
      opacity: 1 !important;
      z-index: 1 !important;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    .bank-group-header .chevron {
      transition: transform 0.3s;
      color: #D1D5DB;
      font-size: 12px;
    }

    .bank-group-header.expanded .chevron {
      transform: rotate(90deg);
      color: var(--text-main);
    }

    .header-action-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 25px;
      margin-bottom: 15px;
    }

    .header-action-row h2 {
      margin: 0;
    }

    /* Modal */
    #custom-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(4px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    .modal-content {
      background: #fff;
      padding: 32px 24px;
      border-radius: 24px;
      width: 85%;
      max-width: 320px;
      text-align: center;
      box-shadow: var(--shadow-lg);
    }

    /* Form Elements for Settings */
    .form-select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      background: #fff;
      color: var(--text-main);
      cursor: pointer;
    }

    .form-input,
    .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: 12px;
      font-size: 14px;
      background: #fff;
      color: var(--text-main);
      box-sizing: border-box;
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .habit-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .habit-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: #F9FAFB;
      border-radius: 12px;
      cursor: pointer;
      transition: 0.2s;
    }

    .habit-item:hover {
      background: #F3F4F6;
    }

    .habit-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    .habit-item span {
      font-size: 14px;
      color: var(--text-main);
    }

    /* Two-column wallet grid */
    .wallet-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    .wallet-grid .visual-card {
      margin-bottom: 0;
    }

    /* Card organization selector */
    .card-org-selector {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .org-btn {
      padding: 4px 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 11px;
      cursor: pointer;
      transition: 0.2s;
    }

    .org-btn.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
  </style>
</head>

<body>

  <div id="toast" class="toast"><i class="fas fa-check-circle" style="color: #4ade80;"></i> <span
      id="toast-msg">è¨­å®šå·²å„²å­˜</span></div>

  <div class="app-container">

    <!-- View 1: Home -->
    <div id="view-home" class="view active">
      <div class="ui-card" style="border:none; box-shadow:none; background:transparent; padding: 10px 0;">
        <div style="font-size:10px; color:#D1D5DB; text-align:right;">Build: v1.0.3-LIVE</div>
        <h1 id="user-name">è¼‰å…¥ä¸­...</h1>
        <p class="subtitle">æ­¡è¿å›ä¾†ï¼ç®¡ç†æ‚¨çš„æ™ºæ…§éŒ¢åŒ…</p>

        <div class="stat-grid">
          <div class="stat-item" onclick="switchView('view-cards')" style="cursor:pointer;">
            <div class="stat-val" id="count-cards">0</div>
            <div class="stat-lbl">æŒæœ‰å¡ç‰‡</div>
          </div>
          <div class="stat-item" onclick="switchView('view-payments')" style="cursor:pointer;">
            <div class="stat-val" id="count-pay">0</div>
            <div class="stat-lbl">æ”¯ä»˜ç¶å®š</div>
          </div>
        </div>

        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <h3 style="font-size:16px;">æˆ‘çš„å¡ç‰‡</h3>
          <span style="font-size:12px; color:var(--primary); cursor:pointer;"
            onclick="switchView('view-cards')">ç·¨è¼¯</span>
        </div>

        <div id="wallet-preview">
          <!-- Dynamic Cards Here -->
          <div style="text-align:center; padding:30px; border:2px dashed #E5E7EB; border-radius:16px; color:#9CA3AF;">
            <i class="fas fa-wallet" style="font-size:24px; margin-bottom:8px;"></i>
            <p style="font-size:13px;">éŒ¢åŒ…æ˜¯ç©ºçš„</p>
          </div>
        </div>
      </div>
      <div class="header">
        <div class="h-left">
          <i class="fas fa-wallet" style="color:var(--primary); font-size:20px;"></i>
          <span style="font-weight:700; font-size:18px;">CardWay <span
              style="font-size:10px; color:#999; font-weight:400;" id="app-ver"></span></span>
        </div>
        <div class="h-right">
          <i class="fas fa-bell header-icon"></i>
        </div>
      </div>
      <button class="primary-btn" onclick="switchView('view-cards')">
        <i class="fas fa-plus" style="margin-right:8px;"></i>æ–°å¢å¡ç‰‡
      </button>
    </div>

    <!-- View 2: Add Cards -->
    <div id="view-cards" class="view">
      <div class="ui-card">
        <h1>é¸æ“‡å¡ç‰‡</h1>
        <p class="subtitle">æœå°‹éŠ€è¡Œä¸¦åŠ å…¥æ‚¨çš„å¡ç‰‡</p>

        <div class="search-container">
          <i class="fas fa-search search-icon"></i>
          <input type="text" id="bank-search" class="search-input" placeholder="æœå°‹éŠ€è¡Œï¼ˆä¾‹å¦‚ï¼šåœ‹æ³°ã€ä¸­ä¿¡ï¼‰..."
            oninput="filterBanks()">
        </div>

        <div class="bank-grid" id="bank-list">
          <!-- Bank Pills -->
        </div>

        <h3 style="font-size:15px; margin-bottom:12px; color:var(--text-main);">å¡ç‰‡åˆ—è¡¨</h3>
        <div class="selection-list" id="card-list">
          <!-- Cards -->
        </div>
      </div>

      <!-- Bottom Summary Bar -->
      <div style="position:fixed; bottom:100px; left:20px; right:20px; max-width:460px; margin:0 auto;">
        <button class="primary-btn" onclick="switchView('view-payments')"
          style="display:flex; justify-content:space-between; padding: 16px 24px;">
          <span>å·²é¸æ“‡ <span id="cart-count">0</span> å¼µ</span>
          <span>ä¸‹ä¸€æ­¥ <i class="fas fa-arrow-right"></i></span>
        </button>
      </div>
    </div>

    <!-- View 3: Payments -->
    <div id="view-payments" class="view">
      <div style="padding: 10px 0;">
        <h1>æ”¯ä»˜ç¶å®š</h1>
        <p class="subtitle">è¨­å®šå„å€‹æ”¯ä»˜å·¥å…·å°æ‡‰çš„å¡ç‰‡</p>

        <div id="payment-mapping-list">
          <!-- Payment logic -->
        </div>
      </div>

      <div style="height: 100px;"></div> <!-- Spacer -->

      <div style="position:fixed; bottom:100px; left:20px; right:20px; max-width:460px; margin:0 auto;">
        <button class="primary-btn" id="save-btn" onclick="saveAll()">
          <i class="fas fa-check" style="margin-right: 8px;"></i>å„²å­˜è¨­å®š
        </button>
      </div>
    </div>

    <!-- View 4: Settings -->
    <div id="view-settings" class="view">
      <div style="padding: 10px 0;">
        <h1>é€²éšè¨­å®š</h1>
        <p class="subtitle">è®“å¡è¡›æ›´äº†è§£ä½ </p>

        <!-- æ€§åˆ¥ -->
        <div class="ui-card">
          <h3 style="font-size:15px; margin-bottom:12px;">æ‚¨çš„æ€§åˆ¥</h3>
          <div class="chip-container">
            <div class="mini-chip" data-gender="male" onclick="selectGender(this)">ç”·</div>
            <div class="mini-chip" data-gender="female" onclick="selectGender(this)">å¥³</div>
            <div class="mini-chip" data-gender="neutral" onclick="selectGender(this)">ä¸­æ€§</div>
            <div class="mini-chip" data-gender="undisclosed" onclick="selectGender(this)">ä¸é€éœ²</div>
          </div>
        </div>

        <!-- ç”Ÿæ—¥æœˆä»½ -->
        <div class="ui-card">
          <h3 style="font-size:15px; margin-bottom:12px;">ç”Ÿæ—¥æœˆä»½</h3>
          <select id="birth-month" class="form-select" onchange="updateProfile()">
            <option value="">è«‹é¸æ“‡</option>
            <option value="1">1 æœˆ</option>
            <option value="2">2 æœˆ</option>
            <option value="3">3 æœˆ</option>
            <option value="4">4 æœˆ</option>
            <option value="5">5 æœˆ</option>
            <option value="6">6 æœˆ</option>
            <option value="7">7 æœˆ</option>
            <option value="8">8 æœˆ</option>
            <option value="9">9 æœˆ</option>
            <option value="10">10 æœˆ</option>
            <option value="11">11 æœˆ</option>
            <option value="12">12 æœˆ</option>
          </select>
        </div>

        <!-- ç”¨å¡ç¿’æ…£ -->
        <div class="ui-card">
          <h3 style="font-size:15px; margin-bottom:12px;">ç”¨å¡ç¿’æ…£ï¼ˆå¯å¤šé¸ï¼‰</h3>
          <div class="habit-list">
            <label class="habit-item">
              <input type="checkbox" name="habit" value="æ¶å„ªæƒ " onchange="updateProfile()">
              <span>ç¿’æ…£å»æ¶ç™»éŒ„é™é‡é™æ™‚ä¿¡ç”¨å¡å„ªæƒ </span>
            </label>
            <label class="habit-item">
              <input type="checkbox" name="habit" value="é…åˆéŠ€è¡Œ" onchange="updateProfile()">
              <span>ç‚ºäº†æ›´é«˜å›é¥‹é…åˆéŠ€è¡Œè¦æ±‚</span>
            </label>
            <label class="habit-item">
              <input type="checkbox" name="habit" value="ç„¡è…¦åˆ·" onchange="updateProfile()">
              <span>ä¸€å¡åˆ°åº•ç„¡è…¦åˆ·</span>
            </label>
            <label class="habit-item">
              <input type="checkbox" name="habit" value="å…¶ä»–" onchange="toggleOtherHabit(this)">
              <span>å…¶ä»–</span>
            </label>
            <input type="text" id="other-habit-text" class="form-input" placeholder="è«‹èªªæ˜æ‚¨çš„ç”¨å¡ç¿’æ…£..."
              style="display:none; margin-top:8px;" onchange="updateProfile()">
          </div>
        </div>

        <!-- ä¸»åŠ›å¡ç‰‡ -->
        <div class="ui-card">
          <h3 style="font-size:15px; margin-bottom:12px;">ä¸»åŠ›å¡ç‰‡ï¼ˆé¸ 1~3 å¼µï¼‰</h3>
          <div class="chip-container" id="main-card-list">
            <!-- å‹•æ…‹æ¸²æŸ“ -->
          </div>
        </div>

        <!-- å¡è¡›å°å•åˆ¸ -->
        <div class="ui-card">
          <h3 style="font-size:15px; margin-bottom:12px;">ğŸ¯ å¡è¡›å°å•åˆ¸</h3>

          <label
            style="font-size:13px; color:var(--text-sub); display:block; margin-bottom:8px;">é™¤äº†å…è²»æŸ¥è©¢æ¨¡å¼ï¼Œé‚„å¸Œæœ›å¢åŠ ä»€éº¼åŠŸèƒ½ï¼Ÿ</label>
          <textarea id="wanted-features" class="form-textarea" placeholder="ä¾‹å¦‚ï¼šè‡ªå‹•æ¨æ’­å„ªæƒ ã€æ¶ˆè²»åˆ†æ..."
            onchange="updateProfile()"></textarea>

          <label
            style="font-size:13px; color:var(--text-sub); display:block; margin:16px 0 8px;">æ¯æœˆé¡˜æ„å°é¡æ”¯æŒæ–°å¢åŠŸèƒ½çš„åƒ¹æ ¼ï¼Ÿ</label>
          <div class="chip-container">
            <div class="mini-chip" data-price="10" onclick="selectPrice(this)">$10</div>
            <div class="mini-chip" data-price="30" onclick="selectPrice(this)">$30</div>
            <div class="mini-chip" data-price="60" onclick="selectPrice(this)">$60</div>
            <div class="mini-chip" data-price="100" onclick="selectPrice(this)">$100</div>
            <div class="mini-chip" data-price="150" onclick="selectPrice(this)">$150</div>
            <div class="mini-chip" data-price="300" onclick="selectPrice(this)">$300</div>
          </div>

          <label style="font-size:13px; color:var(--text-sub); display:block; margin:16px 0 8px;">å‘Šè¨´å¡è¡›ä½ ä¿¡ç”¨å¡æ–¹é¢çš„å°ç—›é»</label>
          <textarea id="pain-points" class="form-textarea" placeholder="ä¾‹å¦‚ï¼šå›é¥‹è¨ˆç®—å¤ªè¤‡é›œã€å„ªæƒ å¤ªå¤šè¨˜ä¸ä½..."
            onchange="updateProfile()"></textarea>
        </div>

      </div>

      <div style="height: 100px;"></div> <!-- Spacer -->

      <div style="position:fixed; bottom:100px; left:20px; right:20px; max-width:460px; margin:0 auto;">
        <button class="primary-btn" onclick="saveAll()">
          <i class="fas fa-check" style="margin-right: 8px;"></i>å„²å­˜è¨­å®š
        </button>
      </div>
    </div>

  </div> <!-- /app-container -->

  <!-- Modal -->
  <div id="custom-modal">
    <div class="modal-content">
      <div style="font-size: 40px; margin-bottom: 16px;" id="modal-icon">ğŸ‘‹</div>
      <h3 style="font-size:18px; margin-bottom:8px;">æç¤º</h3>
      <div id="modal-msg" class="modal-msg" style="color:#6B7280; font-size:14px; margin-bottom:24px;"></div>
      <button class="primary-btn" onclick="closeModal()" style="padding:12px; font-size:14px;">æˆ‘çŸ¥é“äº†</button>
    </div>
  </div>

  <!-- Nav -->
  <div class="nav-bar">
    <div class="nav-item active" onclick="switchView('view-home')" id="nav-home">
      <i class="fas fa-wallet"></i>
      <span>éŒ¢åŒ…</span>
    </div>
    <div class="nav-item" onclick="switchView('view-cards')" id="nav-cards">
      <i class="fas fa-search-plus"></i>
      <span>æ‰¾å¡</span>
    </div>
    <div class="nav-item" onclick="switchView('view-payments')" id="nav-payments">
      <i class="fas fa-mobile-alt"></i>
      <span>æ”¯ä»˜</span>
    </div>
    <div class="nav-item" onclick="switchView('view-settings')" id="nav-settings">
      <i class="fas fa-sliders-h"></i>
      <span>é€²éš</span>
    </div>
  </div>

  <!-- Color Picker Modal -->
  <div id="color-picker-modal" class="color-picker-overlay" onclick="closeColorPicker(event)">
    <div class="color-picker-content" onclick="event.stopPropagation()">
      <h3 style="margin-bottom: 8px;">æ›´æ›å¡ç‰‡é¡è‰²</h3>
      <p style="font-size: 13px; color: var(--text-sub); margin-bottom: 16px;">æŒ‘é¸æœ€é©åˆé€™å¼µå¡ç‰‡çš„åº•è‰²</p>
      <div class="color-grid" id="color-grid">
        <!-- Colors will be rendered here -->
      </div>
      <button class="primary-btn" onclick="resetCardColor()"
        style="margin-top: 20px; background: #9CA3AF; box-shadow: none; padding: 12px; font-size: 14px;">å›å¾©é è¨­æ¼¸å±¤</button>
      <button class="primary-btn" onclick="closeColorPicker()"
        style="margin-top: 8px; background: #6B7280; box-shadow: none; padding: 12px; font-size: 14px;">é—œé–‰</button>
    </div>
  </div>

  <script>
    // Config
    const LIFF_ID = "2008834693-FtenJAlU";
    const VERSION = "v1.4 (Auth Debug)";

    // è‡ªå‹•å¸¶å…¥ GAS URL (æ­£å¼ç’°å¢ƒ)ï¼Œè‹¥æ˜¯åœ¨æœ¬åœ°é–‹ç™¼å‰‡ä¿ç•™è®Šæ•¸ä»¥å…éŒ¯èª¤
    // æ³¨æ„ï¼šæœ¬åœ°é–‹ç™¼æ™‚ <?= gasUrl ?> ä¸æœƒè¢«æ›¿æ›ï¼Œå› æ­¤éœ€è¦åˆ¤æ–·
    let GAS_URL = "<?= gasUrl ?>";
    if (GAS_URL.includes("gasUrl")) {
      // æœ¬åœ°é–‹ç™¼æˆ– GitHub Pages (æœªé€é GAS æ¸²æŸ“) æ™‚çš„ Fallback
      GAS_URL = "https://script.google.com/macros/s/AKfycbzbdllVZFKTHvFm8vlsrfYzHf0BtQjChEoHvVppm8x9T9ayJD0ndfZbFWaaqpMJ4OXp/exec";
    }

    // Auto-detect Mock Mode only for localhost or debugging
    const IS_MOCK = location.hostname === "localhost" || location.hostname.includes("127.0.0.1") || location.protocol === "file:";

    // Data (Same DB)
    const CARD_DB = {
      "004 è‡ºç£éŠ€è¡Œ": [
        "å°ç›²çŠ¬èªåŒå¡",
        "ç¥ç¦èªåŒå¡",
        "ä¸€å¡é€šéˆ¦é‡‘å•†æ—…å¡",
        "é‡‘é‡‡å¡",
        "éˆ¦é‡‘å•†æ—…å¡"
      ],
      "005 åœŸåœ°éŠ€è¡Œ": [
        "icash2.0è¯åéˆ¦é‡‘å¡",
        "éºŸæ´‹ç¾½çƒèªåŒå¡",
        "JCBæ¥µç·»å¡",
        "ç™½é‡‘å•†å‹™å¡"
      ],
      "006 åˆä½œé‡‘åº«": [
        "å¡ç´èµ«æ‹‰çš„å°å‹•ç‰©æ‚ éŠè¯åå¡",
        "ié‹å‹•å¡",
        "æ¨‚æ´»å¡",
        "ä¸–ç•Œå¡",
        "æ´»åŠ›å¾¡ç’½å¡",
        "æ¼¢ä¾†ç¾é£Ÿè¯åå¡"
      ],
      "007 ç¬¬ä¸€éŠ€è¡Œ": [
        "iLEOä¿¡ç”¨å¡",
        "ç¾©äº«å¤©åœ°è¯åå¡",
        "Living Greenç¶ æ´»å¡",
        "éˆ¦é‡‘å•†æ—…å¡",
        "å¾¡ç’½å•†æ—…å¡",
        "æ¡ƒåœ’å¸‚å¸‚æ°‘å¡è¯åå¡",
        "å®œè˜­èªåŒå¡"
      ],
      "008 è¯å—éŠ€è¡Œ": [
        "è¶…é‘½ç¾é‡‘å›é¥‹å¡",
        "SnYä¿¡ç”¨å¡",
        "Rich+å¯Œå®¶å¡",
        "iç¶²è³¼ç”Ÿæ´»å¡",
        "å˜Ÿå˜Ÿæˆ¿è¯åå¡",
        "ç¾é¥Œé¨éŠä¸–ç•Œå¡",
        "å¤§ç”²åª½ç¥–èªåŒå¡"
      ],
      "009 å½°åŒ–éŠ€è¡Œ": [
        "Myæ¨‚ç¾é‡‘å›é¥‹å¡",
        "Myè³¼å¡",
        "Myæ‹œå¡",
        "é¦¬å•èªåŒå¡"
      ],
      "011 ä¸Šæµ·å•†éŠ€": [
        "Teresa Card",
        "å°å°å…µä¿¡ç”¨å¡",
        "ç°¡å–®å¡",
        "ç‰™é†«å¸«èªåŒå¡"
      ],
      "012 å°åŒ—å¯Œé‚¦": [
        "å¯Œé‚¦Costcoè¯åå¡",
        "å¯Œé‚¦Jå¡",
        "momoå¡",
        "Open Possibleè¯åå¡",
        "æ•¸ä½ç”Ÿæ´»å¡",
        "å°Šå¾¡ä¸–ç•Œå¡",
        "å»£ä¸‰SOGOè¯åå¡",
        "å°èŒ‚è¯åå¡"
      ],
      "013 åœ‹æ³°ä¸–è¯": [
        "CUBEå¡",
        "äºæ´²è¬é‡Œé€šè¯åå¡",
        "é•·æ¦®èˆªç©ºè¯åå¡",
        "ä¸–ç•Œå¡",
        "è¦çš®è³¼ç‰©è¯åå¡",
        "å°å¡‘è¯åå¡"
      ],
      "017 å…†è±éŠ€è¡Œ": [
        "åˆ©å¤šå¾¡ç’½å¡",
        "eç§’åˆ·éˆ¦é‡‘å¡",
        "Gogoroè¯åå¡",
        "å®‡å®™æ˜æ˜ŸBT21ä¿¡ç”¨å¡",
        "Mega Oneä¸€å¡é€šè¯åå¡",
        "æµ·æ‚…åœ‹éš›è¯åå¡",
        "å°‡ä¾†éŠ€è¡Œè¯åå¡"
      ],
      "052 æ¸£æ‰“éŠ€è¡Œ": [
        "LINE Bankè¯åå¡",
        "æ¸£æ‰“ç¾é‡‘å›é¥‹å¾¡ç’½å¡",
        "å„ªå…ˆç†è²¡ç„¡é™å¡"
      ],
      "081 æ»™è±éŠ€è¡Œ": [
        "æ—…äººç„¡é™å¡",
        "æ—…äººå¾¡ç’½å¡",
        "æ—…äººè¼•æ—…å¡",
        "Live+ç¾é‡‘å›é¥‹å¡",
        "åŒ¯é‘½å¡",
        "ç¾é‡‘å›é¥‹å¾¡ç’½å¡"
      ],
      "103 æ–°å…‰éŠ€è¡Œ": [
        "å¯°å®‡ç¾é‡‘å›é¥‹å¡",
        "æ–°å…‰ä¸‰è¶Šè¯åå¡",
        "OUé»é»å¡",
        "æ—¥æœ¬èˆªç©ºè¯åå¡",
        "æ‚ éŠè¯åå¡",
        "ESGéŠ€è¡Œå¡"
      ],
      "803 è¯é‚¦éŠ€è¡Œ": [
        "å‰é¶´å¡",
        "LINE Bankè¯åå¡",
        "è³´é»å¡",
        "å¹¸ç¦Må¡",
        "ç¶ å¡",
        "å¾®é¢¨è¯åå¡",
        "ç†è²¡å‹ç„¡é™å¡"
      ],
      "805 é æ±å•†éŠ€": [
        "æ¨‚å®¶+å¡",
        "å¿«æ¨‚ä¿¡ç”¨å¡",
        "C'est Moiæˆ‘çš„å¡",
        "éŠ€è¡Œå¡"
      ],
      "806 å…ƒå¤§éŠ€è¡Œ": [
        "é‘½é‡‘æ™ºå¯Œå¡",
        "å…ƒå¤§é‘½é‡‘å¡",
        "Hello Kittyè¯åå¡",
        "åˆ†äº«é»‘å•¤å¡",
        "iCashè¯åå¡"
      ],
      "807 æ°¸è±éŠ€è¡Œ": [
        "DAWAYå¡",
        "SPORTå¡",
        "å¹£å€å¡",
        "å¤§æˆ¶DAWHOä¿¡ç”¨å¡",
        "ç¾é‡‘å›é¥‹JCBå¡",
        "ä¿å€å¡",
        "MITSUI OUTLET PARKè¯åå¡"
      ],
      "808 ç‰å±±éŠ€è¡Œ": [
        "Unicard",
        "U Bearä¿¡ç”¨å¡",
        "Piæ‹éŒ¢åŒ…ä¿¡ç”¨å¡",
        "ç†Šæœ¬ç†Šå¡",
        "æ˜Ÿå®‡èˆªç©ºè¯åå¡",
        "ç„¡é™å¡",
        "å®¶æ¨‚ç¦è¯åå¡",
        "æ¼¢ç¥å·¨è›‹è¯åå¡",
        "å¯¶é›…è¯åå¡",
        "å…¬å‹™äººå“¡åœ‹æ°‘æ—…éŠå¡"
      ],
      "809 å‡±åŸºéŠ€è¡Œ": [
        "é­”BUYå¡",
        "é­”FUNå¡",
        "ç¾é‡‘å›é¥‹å¡"
      ],
      "810 æ˜Ÿå±•éŠ€è¡Œ": [
        "ecoæ°¸çºŒå¡",
        "é£›è¡Œä¸–ç•Œä¹‹æ¥µå¡",
        "é£›è¡Œä¸–ç•Œå•†å‹™å¡",
        "é¥—æ¨‚ç”Ÿæ´»å¡",
        "PChome Primeè¯åå¡",
        "ç‚«æ™¶å¾¡ç’½å¡",
        "everydayéˆ¦é‡‘å¡"
      ],
      "812 å°æ–°éŠ€è¡Œ": [
        "å¤ªé™½å¡",
        "ç«ç‘°å¡",
        "ç«ç‘°Givingå¡",
        "@GoGoå¡",
        "FlyGoå¡",
        "è¡—å£è¯åå¡",
        "Gogoro Rewardsè¯åå¡",
        "æ–°å…‰ä¸‰è¶Šè¯åå¡",
        "é å‚³friDayè¯åå¡",
        "å¤§æ½¤ç™¼è¯åå¡"
      ],
      "822 ä¸­åœ‹ä¿¡è¨—": [
        "LINE Payä¿¡ç”¨å¡",
        "ä¸­è¯èˆªç©ºè¯åå¡",
        "Agodaè¯åå¡",
        "ä¸­æ²¹è¯åå¡",
        "ALL MEå¡",
        "Foodpandaè¯åå¡",
        "è‹±é›„è¯ç›Ÿä¿¡ç”¨å¡",
        "å•†æ—…éˆ¦é‡‘å¡",
        "Global Mallè¯åå¡",
        "ç§€æ³°è¯åå¡",
        "å—ç´¡è³¼ç‰©ä¸­å¿ƒè¯åå¡",
        "LaLaportè¯åå¡",
        "101è¯åå¡"
      ],
      "[ç„¡] ç¾åœ‹é‹é€š": [
        "ç°½å¸³ç™½é‡‘å¡ (å¤§ç™½)",
        "ä¿¡ç”¨ç™½é‡‘å¡ (å°ç™½)",
        "é•·æ¦®èˆªç©ºç°½å¸³ç™½é‡‘å¡",
        "æ™¶è¯çé¥Œä¿¡ç”¨ç™½é‡‘å¡"
      ],
      "[ç„¡] æ¨‚å¤©ä¿¡ç”¨å¡": [
        "æ¨‚å¤©ä¿¡ç”¨å¡",
        "æ¨‚è™å¡",
        "æ¨‚å¤©Rockyå¡"
      ]
    };

    const PAY_METHODS = [
      { name: "LINE Pay", icon: "fab fa-line" },
      { name: "è¡—å£æ”¯ä»˜", icon: "fas fa-store" },
      { name: "å…¨æ”¯ä»˜", icon: "fas fa-coins" },
      { name: "æ‚ éŠä»˜", icon: "fas fa-ticket-alt" },
      { name: "å°ç£ Pay", icon: "fas fa-qrcode" },
      { name: "icash Pay", icon: "fas fa-wallet" },
      { name: "Pi æ‹éŒ¢åŒ…", icon: "fas fa-shopping-bag" }
    ];

    let selectedBank = "013 åœ‹æ³°ä¸–è¯";
    let myWallet = [];
    let payMap = {};

    // Init
    window.onload = async () => {
      try {
        await initApp();
      } catch (e) {
        console.error(e);
        showModal("æ‡‰ç”¨ç¨‹å¼è¼‰å…¥ç•°å¸¸: " + e.message, "âš ï¸");
      }
    };

    async function initApp() {
      let displayName = "è¨ªå®¢";

      if (IS_MOCK) {
        displayName = "æ¨¡æ“¬ç”¨æˆ¶";
        // Mock profile name
        userProfile.displayName = displayName;
        showToast("ğŸ”§ é è¦½æ¨¡å¼ï¼šä½¿ç”¨æœ¬åœ°æ¨¡æ“¬æ•¸æ“š");
      } else {
        try {
          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }
          const profile = await liff.getProfile();
          displayName = profile.displayName;
          userProfile.displayName = displayName;
          // showToast(`ç™»å…¥æˆåŠŸ: ${displayName}`); 
        } catch (err) {
          console.warn("LIFF Init Failed", err);
          showModal("LIFF åˆå§‹åŒ–å¤±æ•—: " + err.message, "âš ï¸");
          displayName = "æ¨¡æ“¬ç”¨æˆ¶";
        }
      }

      document.getElementById('user-name').innerText = `Hi, ${displayName}`;
      document.getElementById('app-ver').innerText = VERSION;
      await loadSettings();

      renderBanks();
      renderCards(selectedBank);
      renderPaymentSetup();
      updateHomeStats();
    }

    // Logic
    async function loadSettings() {
      if (IS_MOCK) {
        // æœ¬åœ°é è¦½æ¨¡å¼ï¼šå¾ localStorage è®€å–
        const saved = localStorage.getItem('cardway_data_v2');
        if (saved) {
          const parsed = JSON.parse(saved);
          myWallet = Array.isArray(parsed.myWallet) ? parsed.myWallet : [];
          payMap = (typeof parsed.payMap === 'object') ? parsed.payMap : {};
        }
        updateCartCount();
        return;
      }

      try {
        const idToken = liff.getIDToken();
        const decoded = liff.getDecodedIDToken();
        const userId = decoded ? decoded.sub : null; // ç›´æ¥å–å¾— User ID

        // Fallback for Mock
        if (!userId && !IS_MOCK) throw new Error("ç„¡ User ID");

        const res = await fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({
            action: "get_settings",
            idToken: idToken,
            userId: userId // å‚³é€ User ID
          })
        });
        const data = await res.json();

        if (data.success === false) {
          console.error("Server API Error", data.msg);
          // Optional: showModal("åŒæ­¥å¤±æ•—: " + data.msg);
        } else if (data.settings) {
          myWallet = Array.isArray(data.settings.myWallet) ? data.settings.myWallet : [];
          payMap = (typeof data.settings.payMap === 'object') ? data.settings.payMap : {};
          myWallet = myWallet.filter(c => c && c.name);
          // è¼‰å…¥ profile
          if (data.settings.profile) {
            Object.assign(userProfile, data.settings.profile);
          }
        }
      } catch (e) {
        console.error("Sync Error", e);
        // showModal("è®€å–è¨­å®šå¤±æ•—: " + e.message, "âš ï¸");
      }
      updateCartCount();
    }

    // ... (skipped standard functions)

    async function saveAll() {
      const btn = document.getElementById('save-btn');
      const oldText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åŒæ­¥ä¸­...';
      btn.disabled = true;

      if (IS_MOCK) {
        // æœ¬åœ°é è¦½æ¨¡å¼ï¼šå„²å­˜åˆ° localStorage
        localStorage.setItem('cardway_data_v2', JSON.stringify({ myWallet, payMap, profile: userProfile }));
        setTimeout(() => {
          finishSave(btn, oldText);
        }, 500);
        return;
      }

      // Real Cloud Save
      try {
        const idToken = liff.getIDToken();
        const decoded = liff.getDecodedIDToken();
        const userId = decoded ? decoded.sub : null;

        if (!userId) throw new Error("ç„¡æ³•å–å¾— User ID (Save)");

        console.log("Saving to:", GAS_URL); // Debug URL

        const res = await fetch(GAS_URL, {
          method: 'POST',
          // Google Apps Script æœ‰æ™‚å° CORS å¾ˆåš´æ ¼ï¼Œç”¨ text/plain é€šå¸¸æœ€ç©©
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({
            action: "save_settings",
            idToken,
            userId,
            myWallet,
            payMap,
            profile: userProfile
          })
        });

        const text = await res.text();
        console.log("Server Response Raw:", text); // Debug Raw Response

        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          // å¦‚æœå›å‚³çš„æ˜¯ HTML (é€šå¸¸æ˜¯ 404 æˆ– Google éŒ¯èª¤é é¢)ï¼Œé€™è£¡æœƒå ±éŒ¯
          throw new Error(`ä¼ºæœå™¨å›æ‡‰é JSON (å¯èƒ½ç¶²å€éŒ¯äº†æˆ–æ¬Šé™ä¸è¶³): ${text.substring(0, 100)}...`);
        }

        if (data.success || data.status === 'success') {
          finishSave(btn, oldText);
        } else {
          throw new Error(data.msg || "æœªçŸ¥ä¼ºæœå™¨éŒ¯èª¤");
        }
      } catch (e) {
        console.error("Save Failed:", e);
        showModal(`å„²å­˜å¤±æ•—ï¼\néŒ¯èª¤: ${e.message}\n(è«‹æˆªåœ–çµ¦å·¥ç¨‹å¸«)`, "âŒ");
        btn.innerHTML = oldText;
        btn.disabled = false;
      }
    }

    function switchView(viewId) {
      window.scrollTo(0, 0);
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

      const target = document.getElementById(viewId);
      target.classList.add('active');

      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      const navId = 'nav-' + viewId.split('-')[1];
      if (document.getElementById(navId)) document.getElementById(navId).classList.add('active');

      // Re-render specifics
      if (viewId === 'view-home') updateHomeStats();
      if (viewId === 'view-cards') {
        selectedBank = null;
        document.getElementById('bank-search').value = '';
        renderBanks();
        renderCards(null);
      }
      if (viewId === 'view-payments') renderPaymentSetup();
      if (viewId === 'view-settings') renderSettingsView();
    }

    // Render Banks as Pills
    function renderBanks(filter = "") {
      const container = document.getElementById('bank-list');
      container.innerHTML = '';
      const searchKey = filter.trim().toLowerCase();

      const banks = Object.keys(CARD_DB).filter(b => b.toLowerCase().includes(searchKey));

      if (banks.length === 0) {
        container.innerHTML = `<div style="width:100%; text-align:center; color:#9CA3AF; padding:10px;">æ‰¾ä¸åˆ°éŠ€è¡Œ</div>`;
        return;
      }

      banks.forEach(bank => {
        const pill = document.createElement('div');
        pill.className = `bank-pill ${bank === selectedBank ? 'active' : ''}`;
        pill.innerText = bank.split(" ")[1] || bank;
        pill.onclick = () => {
          selectedBank = bank;
          renderBanks(filter); // Re-render pills to update active state
          renderCards(bank);
        };
        container.appendChild(pill);
      });
    }

    function filterBanks() {
      renderBanks(document.getElementById('bank-search').value);
    }

    // Render Cards List
    function renderCards(bank) {
      const container = document.getElementById('card-list');
      container.innerHTML = '';

      if (!bank || !CARD_DB[bank] || CARD_DB[bank].length === 0) {
        container.innerHTML = `<div style="text-align:center; color:#9CA3AF; padding:20px;">è«‹å…ˆæŒ‘é¸ç™¼å¡éŠ€è¡Œ</div>`;
        return;
      }

      const cards = CARD_DB[bank];

      // åˆ¤æ–·æ˜¯å¦ç‚ºç‰¹æ®Šå¡çµ„ç¹”ï¼ˆä¸é¡¯ç¤ºé¸æ“‡å™¨ï¼‰
      const isSpecialOrg = bank.includes('ç¾åœ‹é‹é€š') || bank.includes('æ¨‚å¤©');

      cards.forEach(cardName => {
        const item = document.createElement('div');
        item.className = 'selection-item';
        item.style.flexDirection = 'column';
        item.style.alignItems = 'stretch';

        const existingCard = myWallet.find(c => c.name === cardName && c.bank === bank);
        const isSelected = !!existingCard;
        const currentOrg = existingCard?.org || '';

        // Card info row
        const infoRow = document.createElement('div');
        infoRow.style.cssText = 'display:flex; justify-content:space-between; align-items:center; width:100%;';
        infoRow.innerHTML = `
                <div>
                    <div style="font-weight:600; font-size:15px; margin-bottom:2px;">${cardName}</div>
                    <div style="font-size:12px; color:var(--text-sub);">${bank}</div>
                </div>
              `;

        const btn = document.createElement('button');
        btn.className = `action-btn ${isSelected ? 'remove-icon' : 'add-icon'}`;
        btn.innerHTML = isSelected ? '<i class="fas fa-minus"></i>' : '<i class="fas fa-plus"></i>';
        btn.onclick = () => toggleCard(bank, cardName, '');

        infoRow.appendChild(btn);
        item.appendChild(infoRow);

        // Card organization selector (only for non-special cards)
        if (isSelected && !isSpecialOrg) {
          const orgSelector = document.createElement('div');
          orgSelector.className = 'card-org-selector';

          ['na', 'visa', 'mastercard', 'jcb'].forEach(org => { // na means N/A
            const orgBtn = document.createElement('button');
            const isActive = (org === 'na' && !currentOrg) || (currentOrg === org);
            orgBtn.className = `org-btn ${isActive ? 'active' : ''}`;
            orgBtn.innerText = org === 'na' ? 'N/A' : org.toUpperCase();
            orgBtn.onclick = (e) => {
              e.stopPropagation();
              updateCardOrg(bank, cardName, org === 'na' ? '' : org);
            };
            orgSelector.appendChild(orgBtn);
          });

          item.appendChild(orgSelector);
        }

        container.appendChild(item);
      });
    }

    function updateCardOrg(bank, cardName, org) {
      const card = myWallet.find(c => c.name === cardName && c.bank === bank);
      if (card) {
        card.org = org;
        renderCards(bank);
        showToast(`å·²è¨­å®šç‚º ${org.toUpperCase()}`);
      }
    }

    function toggleCard(bank, name, org = '') {
      const idx = myWallet.findIndex(c => c.name === name);
      if (idx > -1) {
        myWallet.splice(idx, 1);
        // Clean payMap
        Object.keys(payMap).forEach(key => {
          payMap[key] = payMap[key].filter(n => n !== name);
        });
        // Clean mainCards
        userProfile.mainCards = userProfile.mainCards.filter(n => n !== name);
      } else {
        myWallet.push({ bank, name, org });
      }

      updateCartCount();
      renderCards(bank); // Update UI
      showToast(idx > -1 ? "å·²ç§»é™¤å¡ç‰‡" : "å·²åŠ å…¥å¡ç‰‡");
    }

    function updateCartCount() {
      document.getElementById('cart-count').innerText = myWallet.length;
    }

    // Render Payments
    function renderPaymentSetup() {
      const container = document.getElementById('payment-mapping-list');
      container.innerHTML = '';

      if (myWallet.length === 0) {
        container.innerHTML = `<div style="text-align:center; padding:30px; color:#9CA3AF;">è«‹å…ˆè‡³ã€Œæ‰¾å¡ã€é é¢åŠ å…¥å¡ç‰‡</div>`;
        return;
      }

      PAY_METHODS.forEach(method => {
        const div = document.createElement('div');
        div.className = 'pay-section';

        const selectedCards = payMap[method.name] || [];

        div.innerHTML = `
                <div class="pay-header">
                    <div class="pay-icon"><i class="${method.icon}"></i></div>
                    <span>${method.name}</span>
                </div>
              `;

        const chipCont = document.createElement('div');
        chipCont.className = 'chip-container';

        myWallet.forEach(card => {
          const chip = document.createElement('div');
          const isSelected = selectedCards.includes(card.name);
          chip.className = `mini-chip ${isSelected ? 'selected' : ''}`;
          chip.innerText = card.name;
          chip.onclick = () => {
            if (!payMap[method.name]) payMap[method.name] = [];

            if (isSelected) {
              payMap[method.name] = payMap[method.name].filter(n => n !== card.name);
            } else {
              payMap[method.name].push(card.name);
            }
            renderPaymentSetup(); // Re-render to show state
          };
          chipCont.appendChild(chip);
        });

        div.appendChild(chipCont);
        container.appendChild(div);
      });
    }

    // Home & Visuals
    // State for collapsing
    let expandedBanks = new Set();
    let isAllExpanded = false;

    function updateHomeStats() {
      // Numbers
      document.getElementById('count-cards').innerText = myWallet.length;
      const linkedCount = Object.values(payMap).reduce((acc, curr) => acc + curr.length, 0);
      document.getElementById('count-pay').innerText = linkedCount;

      // Visual Cards
      const preview = document.getElementById('wallet-preview');
      preview.innerHTML = '';

      if (myWallet.length === 0) {
        preview.innerHTML = `
                <div style="text-align:center; padding:30px; border:2px dashed #E5E7EB; border-radius:16px; color:#9CA3AF;">
                    <i class="fas fa-wallet" style="font-size:24px; margin-bottom:8px;"></i>
                    <p style="font-size:13px;">éŒ¢åŒ…æ˜¯ç©ºçš„</p>
                </div>`;
        return;
      }

      // Group cards by bank
      const groups = {};
      myWallet.forEach(card => {
        if (!groups[card.bank]) groups[card.bank] = [];
        groups[card.bank].push(card);
      });

      // Header row with Expand All
      const headerRow = document.createElement('div');
      headerRow.className = 'header-action-row';
      headerRow.innerHTML = `
        <h2 class="section-title">æˆ‘çš„å¡ç‰‡</h2>
        <div class="toggle-all-btn" onclick="toggleAllGroups()">
          ${isAllExpanded ? 'æ”¶åˆå…¨éƒ¨' : 'å±•é–‹å…¨éƒ¨'}
        </div>
      `;
      preview.appendChild(headerRow);

      const gridContainer = document.createElement('div');
      gridContainer.className = 'wallet-grid';

      Object.keys(groups).sort().forEach(bankName => {
        const groupCards = groups[bankName];
        const isExpanded = expandedBanks.has(bankName) || isAllExpanded;

        // Group Content
        const groupContent = document.createElement('div');
        groupContent.className = `cards-container ${isExpanded ? 'expanded' : ''}`;
        groupContent.onclick = () => toggleBankGroup(bankName);

        groupCards.forEach(card => {
          const div = document.createElement('div');
          div.className = 'visual-card';
          div.setAttribute('data-bank', card.bank);

          if (card.color) {
            div.style.background = card.color;
          }

          const cardOrg = card.org;
          let orgIconHtml = '';
          if (cardOrg) {
            const orgIcon = cardOrg === 'mastercard' ? 'fa-cc-mastercard' :
              cardOrg === 'jcb' ? 'fa-cc-jcb' : 'fa-cc-visa';
            orgIconHtml = `<i class="fab ${orgIcon} vc-logo"></i>`;
          }

          div.innerHTML = `
                  <div class="vc-settings-btn" onclick="toggleCardActions(event, '${card.name}-${card.bank}')">
                      <i class="fas fa-cog"></i>
                  </div>
                  <div class="vc-actions-menu" id="actions-${card.name}-${card.bank}">
                      <div class="vc-action-item" onclick="openColorPicker('${card.name}', '${card.bank}')">
                          <i class="fas fa-palette"></i> æ›è‰²
                      </div>
                      <div class="vc-action-item delete" onclick="removeCardFromHome('${card.name}', '${card.bank}')">
                          <i class="fas fa-trash-alt"></i> ç§»é™¤
                      </div>
                  </div>
                  <div class="vc-top">
                      <div class="vc-bank">${card.bank.split(" ")[1] || card.bank}</div>
                  </div>
                  <div class="vc-info-main">
                      <div class="vc-name">${card.name}</div>
                  </div>
                  ${orgIconHtml}
                `;
          groupContent.appendChild(div);
        });
        gridContainer.appendChild(groupContent);
      });

      preview.appendChild(gridContainer);
    }

    function toggleBankGroup(bankName) {
      if (expandedBanks.has(bankName)) {
        expandedBanks.delete(bankName);
        isAllExpanded = false;
      } else {
        expandedBanks.add(bankName);
      }
      updateHomeStats();
    }

    function toggleAllGroups() {
      isAllExpanded = !isAllExpanded;
      if (!isAllExpanded) {
        expandedBanks.clear();
      }
      updateHomeStats();
    }

    function toggleAllGroups() {
      isAllExpanded = !isAllExpanded;
      if (!isAllExpanded) {
        expandedBanks.clear();
      }
      updateHomeStats();
    }

    function removeCardFromHome(name, bank) {
      if (!confirm('ç¢ºå®šè¦ç§»é™¤é€™å¼µ ' + name + ' å—ï¼Ÿ')) return;

      const idx = myWallet.findIndex(c => c.name === name && c.bank === bank);
      if (idx > -1) {
        myWallet.splice(idx, 1);
        Object.keys(payMap).forEach(key => {
          payMap[key] = payMap[key].filter(n => n !== name);
        });
        userProfile.mainCards = userProfile.mainCards.filter(n => n !== name);

        updateHomeStats();
        updateCartCount();
        showToast("å·²ç§»é™¤å¡ç‰‡");

        if (IS_MOCK) {
          localStorage.setItem('cardway_data_v2', JSON.stringify({ myWallet, payMap, profile: userProfile }));
        }
      }
    }

    function toggleCardActions(e, id) {
      e.stopPropagation();
      // Close other menus first
      document.querySelectorAll('.vc-actions-menu').forEach(m => {
        if (m.id !== 'actions-' + id) m.style.display = 'none';
      });

      const menu = document.getElementById('actions-' + id);
      menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';

      // Global click to close
      if (menu.style.display === 'flex') {
        setTimeout(() => {
          window.onclick = () => {
            menu.style.display = 'none';
            window.onclick = null;
          };
        }, 0);
      }
    }

    // Color Picker Logic
    let activeEditCard = null;
    const PRESET_COLORS = [
      'linear-gradient(135deg, #2D3436 0%, #000000 100%)', // Midnight Black
      'linear-gradient(135deg, #434343 0%, #000000 100%)', // Onyx
      'linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%)', // Deep Ocean
      'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)', // Cobalt
      'linear-gradient(135deg, #00b09b 0%, #96c93d 100%)', // Nature Emerald
      'linear-gradient(135deg, #0093E9 0%, #80D0C7 100%)', // Tropical Aqua
      'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)', // Soft Sakura
      'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', // Warm Flame
      'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)', // Lavender Dream
      'linear-gradient(135deg, #8e2de2 0%, #4a00e0 100%)', // Vivid Purple
      'linear-gradient(135deg, #f83600 0%, #f9d423 100%)', // Sunrise
      'linear-gradient(135deg, #ee0979 0%, #ff6a00 100%)', // Passion
      'linear-gradient(135deg, #d31027 0%, #ea384d 100%)', // Crimson
      'linear-gradient(135deg, #1d976c 0%, #93f9b9 100%)', // Fresh Mint
      'linear-gradient(145deg, #e6e9f0 0%, #eef1f5 100%)', // Silver Spark
      'linear-gradient(135deg, #616161 0%, #9bc5c3 100%)'  // Modern Slate
    ];

    function openColorPicker(name, bank) {
      activeEditCard = { name, bank };
      const modal = document.getElementById('color-picker-modal');
      const grid = document.getElementById('color-grid');
      grid.innerHTML = '';

      PRESET_COLORS.forEach(color => {
        const opt = document.createElement('div');
        opt.className = 'color-option';
        opt.style.background = color;
        opt.onclick = () => selectCardColor(color);
        grid.appendChild(opt);
      });

      modal.style.display = 'flex';
    }

    function closeColorPicker(e) {
      document.getElementById('color-picker-modal').style.display = 'none';
    }

    function selectCardColor(color) {
      if (!activeEditCard) return;
      const card = myWallet.find(c => c.name === activeEditCard.name && c.bank === activeEditCard.bank);
      if (card) {
        card.color = color;
        updateHomeStats();
        silentlySave();
        closeColorPicker();
      }
    }

    function resetCardColor() {
      if (!activeEditCard) return;
      const card = myWallet.find(c => c.name === activeEditCard.name && c.bank === activeEditCard.bank);
      if (card) {
        delete card.color;
        updateHomeStats();
        silentlySave();
        closeColorPicker();
      }
    }

    function silentlySave() {
      if (IS_MOCK) {
        localStorage.setItem('cardway_data_v2', JSON.stringify({ myWallet, payMap, profile: userProfile }));
        return;
      }
      // Trigger update via saveAll(false) or separate call
      // Because saveAll has UI loading, we might need a silent version
      saveAllSilent();
    }

    async function saveAllSilent() {
      try {
        const idToken = liff.getIDToken();
        const decoded = liff.getDecodedIDToken();
        const userId = decoded ? decoded.sub : null;
        if (!userId) return;

        await fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify({
            action: "save_settings",
            idToken,
            userId,
            myWallet,
            payMap,
            profile: userProfile
          })
        });
      } catch (e) { console.error("Silent Save Failed", e); }
    }

    function finishSave(btn, oldText) {
      btn.innerHTML = oldText;
      btn.disabled = false;
      showToast("âœ… è¨­å®šå·²åŒæ­¥è‡³é›²ç«¯");
    }

    // Utils
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.innerHTML = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }
    function showModal(msg, icon = "ğŸ‘‹") {
      document.getElementById('modal-icon').innerText = icon;
      document.getElementById('modal-msg').innerText = msg;
      document.getElementById('custom-modal').style.display = 'flex';
    }
    function closeModal() {
      document.getElementById('custom-modal').style.display = 'none';
    }

    // Settings Page Functions
    let userProfile = {
      gender: '',
      birthMonth: '',
      cardHabits: [],
      mainCards: [],
      wantedFeatures: '',
      supportPrice: 0,
      painPoints: ''
    };

    function selectGender(el) {
      document.querySelectorAll('[data-gender]').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
      userProfile.gender = el.dataset.gender;
    }

    function selectPrice(el) {
      document.querySelectorAll('[data-price]').forEach(e => e.classList.remove('selected'));
      el.classList.add('selected');
      userProfile.supportPrice = parseInt(el.dataset.price);
    }

    function toggleOtherHabit(checkbox) {
      const textInput = document.getElementById('other-habit-text');
      textInput.style.display = checkbox.querySelector('input').checked ? 'block' : 'none';
      updateProfile();
    }

    function toggleMainCard(cardName) {
      const idx = userProfile.mainCards.indexOf(cardName);
      if (idx > -1) {
        userProfile.mainCards.splice(idx, 1);
      } else if (userProfile.mainCards.length < 3) {
        userProfile.mainCards.push(cardName);
      } else {
        showToast('æœ€å¤šé¸æ“‡ 3 å¼µä¸»åŠ›å¡ç‰‡');
        return;
      }
      renderMainCards();
    }

    function renderMainCards() {
      const container = document.getElementById('main-card-list');
      if (!container) return;
      container.innerHTML = '';

      if (myWallet.length === 0) {
        container.innerHTML = '<div style="color:#9CA3AF; font-size:13px;">è«‹å…ˆåŠ å…¥å¡ç‰‡</div>';
        return;
      }

      myWallet.forEach(card => {
        const chip = document.createElement('div');
        const isSelected = userProfile.mainCards.includes(card.name);
        chip.className = `mini-chip ${isSelected ? 'selected' : ''}`;
        chip.innerText = card.name;
        chip.onclick = () => toggleMainCard(card.name);
        container.appendChild(chip);
      });
    }

    function updateProfile() {
      // Get birth month
      userProfile.birthMonth = document.getElementById('birth-month')?.value || '';

      // Get habits
      userProfile.cardHabits = [];
      document.querySelectorAll('input[name="habit"]:checked').forEach(cb => {
        userProfile.cardHabits.push(cb.value);
      });
      const otherText = document.getElementById('other-habit-text')?.value;
      if (otherText) userProfile.cardHabits.push(otherText);

      // Get textarea values
      userProfile.wantedFeatures = document.getElementById('wanted-features')?.value || '';
      userProfile.painPoints = document.getElementById('pain-points')?.value || '';
    }

    function renderSettingsView() {
      renderMainCards();

      // Restore saved profile values
      if (userProfile.gender) {
        document.querySelectorAll('[data-gender]').forEach(e => {
          if (e.dataset.gender === userProfile.gender) e.classList.add('selected');
        });
      }
      if (userProfile.birthMonth) {
        document.getElementById('birth-month').value = userProfile.birthMonth;
      }
      if (userProfile.supportPrice) {
        document.querySelectorAll('[data-price]').forEach(e => {
          if (parseInt(e.dataset.price) === userProfile.supportPrice) e.classList.add('selected');
        });
      }
    }
  </script>
</body>

</html>